<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend">123</div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(5em)}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"taiwan-map",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[{url:"https://d3js.org/topojson.v2.min.js",async:false},{url:"https://d3js.org/d3-geo.v2.min.js",async:false}]},init:function(t){var e,n,i,r,o;e=t.root,n=t.ctx,i=t.pubsub,r=t.data,o=t.manager;return mod({ctx:n,data:r,manager:o,cls:this._instance.block}).then(function(t){return i.fire("init",{mod:t}).then(function(t){return t[0]})})}};mod=function(t){var e,n,i,r,c,d,o,a;e=t.ctx,n=t.data,i=t.manager,r=t.cls;c=e.chart,d=e.d3,o=e.ldcolor,a=e.topojson;return Promise.resolve().then(function(){var a,t;a=n.level||"county";t=[{name:"pdmaptw",version:"main",path:"index.min.js",async:false},{name:"pdmaptw",version:"main",path:a+".map.js"}];return i.rescope.load(t,r.context()).then(function(t){var o;o=t.pdmaptw;return o.get(a).then(function(t){var n,e,i,r;n=t.meta,e=t.topo;i=e.objects.pdmaptw.geometries.map(function(e){return["c","t","v"].map(function(t){return e.properties[t]}).filter(function(t){return t!=null}).map(function(t){return n.name[t]}).join("")});return{sample:function(){return o.get(a).then(function(t){var e,n;e=t.meta,n=t.topo;return{raw:i.map(function(t){return{val:(100*Math.random()).toFixed(2),name:o.normalize(t),cat:"P"+Math.ceil(5*Math.random())}}),binding:{cat:{key:"cat"},name:{key:"name"}}}})},config:{border:{color:{type:"color",default:"#fff"},width:{type:"number",default:1,min:0,max:100,step:.5},linejoin:{type:"choice",values:["round","bevel","miter"],default:"round"}},palette:{type:"palette"},legend:(r=import$({},c.utils.config.preset.legend),r.format={type:"text",default:""},r.exp={type:"number",default:0,min:-1,max:1,step:.01},r)},dimension:{name:{type:"N",name:"縣市"},color:{type:"R",name:"顏色/數值"},cat:{type:"C",name:"顏色/分類"}},init:function(){var e,t,i=this;this.tint=e=new c.utils.tint;this.g=this.layout.getGroup("view");this.obj=new o({root:this.g,type:a});this.scale=t={color:d.interpolateTurbo};this.legend=new c.utils.legend({root:this.root,name:"legend",layout:this.layout,shape:function(t){return d.select(this).attr("fill",e.get(t.key))}});this.legend.on("select",function(){i.bind();i.resize();return i.render()});this.tip=new c.utils.tip({root:this.root,accessor:function(t){var e,n;e=t.evt;if(!(e.target&&(n=d.select(e.target).datum()))){return null}return{name:n.data.name,value:i.useColor?n.data.color||"-":n.data.cat}},range:function(){return i.layout.getNode("view").getBoundingClientRect()}});return this.obj.init().then(function(){d.select(i.svg).selectAll("path").attr("opacity",0);return i.obj.fit({node:i.g,box:i.layout.getNode("view").getBoundingClientRect()})})},parse:function(){var n=this;this.tint.reset();this.extent={c:[undefined,undefined]};d.select(this.svg).selectAll("path").each(function(e,t){e.data=n.data.filter(function(t){return t.name===e.properties.name})[0]||{name:e.properties.name};if(!(n.extent.c[0]!=null)||e.data.color<n.extent.c[0]){n.extent.c[0]=e.data.color}if(!(n.extent.c[1]!=null)||e.data.color>n.extent.c[1]){return n.extent.c[1]=e.data.color}});return this.legend.config(this.cfg.legend)},resize:function(){var t,e,n,i,r,o,a,l,s,u;this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);this.obj.fit(this.layout.getBox("view"));e=this.cfg.palette?this.cfg.palette.colors:["#f00","#999","#00f"];n=e.length;this.useColor=this.binding.color!=null;if(this.useColor){i=(r=this.binding.color.unit)?r:"";try{o=d.format(this.cfg.legend.format||".2f")}catch(t){a=t;o=d.format(".1f")}t=c.utils.tick({extent:this.extent.c,len:n,legend:{range:true,format:o,unit:i},exp:this.cfg.legend.exp||0}),l=t.ticks,s=t.extent,u=t.labels;this.tint.mode(c.utils.tint.mode.ranges);this.tint.extent(l);this.legend.data(u)}else if(this.binding.cat){this.tint.mode(c.utils.tint.mode.ordinal);l=Array.from(new Set(this.data.map(function(t){return t.cat}))).map(function(t){return{key:t,text:t}});this.legend.data(l)}this.tint.set(this.cfg.palette);return this.obj.fit({node:this.g,box:this.layout.getBox("view")})},render:function(){var n=this;if(!this.obj.scale){return}d.select(this.svg).selectAll("path").transition().duration(350).attr("fill",function(t,e){if(n.useColor){if(n.extent.c[0]==null){return"#fff"}return n.tint.get(t.data.color)}else{return n.tint.get(t.data.cat)}}).attr("opacity",function(t,e){if(n.useColor){if(n.legend.isSelected(t.data.color)){return 1}else{return.1}}else if(n.legend.isSelected(t.data.cat)){return 1}else{return.1}}).attr("fill-opacity",function(t,e){if(n.useColor){if(n.extent.c[0]==null){return 0}if(n.cfg.dimEmpty){if(t.data.color!=null){return 1}else{return.2}}else{return 1}}else{if(n.cfg.dimEmpty){if(t.data.cat!=null){return 1}else{return.2}}else{return 1}}}).attr("stroke",this.cfg.border.color).attr("stroke-width",this.cfg.border.width/this.obj.scale()).attr("stroke-linejoin",this.cfg.border.linejoin);return this.legend.render()}}})})})};function import$(t,e){var n={}.hasOwnProperty;for(var i in e)if(n.call(e,i))t[i]=e[i];return t}</script></div>