<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div><div data-name="tip"><div ld="name"></div><div ld="value1"></div><div ld="value2"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(10em)}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=view]{grid-area:1/1}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:2;grid-row:1;padding:0 .5em 0 .5em}.pdl-layout.legend-below>div[data-type=layout]{grid-template-columns:1fr;grid-template-rows:1fr fit-content(2em)}.pdl-layout.legend-below>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1;grid-row:2}[data-name=tip]{padding:.4em .5em;background:#13171a;color:#fff;border-radius:3px;box-shadow:0 2px 4px rgba(0,0,0,0.3);line-height:1.2em;font-size:.9em;max-width:10em;word-break:break-all}[data-name=tip] [ld=name]{font-size:.85em}[data-name=tip] [ld=value1],[data-name=tip] [ld=value2]{font-weight:bold;font-size:1.1em;line-height:1.2em}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"pie-bubble",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[]},init:function(t){var e,n,i;e=t.root,n=t.context,i=t.pubsub;return i.fire("init",{mod:mod({context:n})}).then(function(t){return t[0]})}};mod=function(t){var e,s,r,l,n,i;e=t.context;s=e.d3,r=e.forceBoundary,l=e.ldcolor,n=e.chart;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50].map(function(t){return{name:"N-"+t,val1:(Math.random()*100).toFixed(2),val2:(Math.random()*100).toFixed(2)}}),binding:{name:{key:"name"},left:{key:"val1",name:"Left"},right:{key:"val2",name:"Right"}}}},config:(i=import$({},n.utils.config.preset["default"]),i.color={left:{type:"color",default:"#222"},right:{type:"color",default:"#b1003b"}},i),dimension:{name:{type:"N",name:"name"},left:{type:"R",name:"size in left"},right:{type:"R",name:"size in right"}},init:function(){var e,a=this;this.tint=e=new n.utils.tint;this.valid=[];this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,s.select(a.layout.getGroup(t))]}));this.tip=new n.utils.tip({root:this.root,node:this.root.querySelector("[data-name=tip]"),view:{name:function(t){var e;e=t.ctx;if(e){return e.name}else{return""}},value1:function(t){var e;e=t.ctx;if(e){return e.value1}else{return""}},value2:function(t){var e;e=t.ctx;if(e){return e.value2}else{return""}}},accessor:function(t){var e,n,i,r;e=t.evt;if(!(e.target&&(n=s.select(e.target).datum()))){return null}i=a.binding.left.unit||a.binding.right.unit||"";r=s.format(".3s");return{name:n.name||"",value1:a.legendData[0].text+": "+r(n.L)+i,value2:a.legendData[1].text+": "+r(n.R)+i}},range:function(){return a.layout.getNode("view").getBoundingClientRect()}});this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return s.select(this).attr("fill",e.get(t.key))},cfg:{selectable:true}});return this.legend.on("select",function(){a.bind();a.resize();return a.render()})},destroy:function(){return this.tip.destroy()},parse:function(){var n=this;this.valid=this.data.filter(function(t){return!isNaN(t.left+t.right)});this.legendData=["left","right"].map(function(t){var e;e=n.binding[t]?n.binding[t].name||n.binding[t].key:t;return{key:e,text:e}});return this.legend.data(this.legendData)},resize:function(){var t,u,h,i=this;this.sim=null;this.start();(t=this.cfg).tip||(t.tip={});(t=this.cfg).color||(t.color={});(t=this.cfg).legend||(t.legend={});this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);this.color=[this.cfg.color.left||(this.color?this.color[0]:this.tint.get(0)),this.cfg.color.right||(this.color?this.color[1]:this.tint.get(1))];this.tint.set({colors:this.color,maps:this.legendData.map(function(t){return t.key})},true);this.legend.config((t=this.cfg.legend,t.selectable=false,t));this.legend.update();this.layout.update(false);this.vbox=u=this.layout.getBox("view");h=s.randomUniform.source(s.randomLcg(this.seed))(0,1);this.valid.map(function(t){var e,n,i,r,a,s,l,o;e=[(e=t.left)>0?e:0,(e=t.right)>0?e:0],n=e[0],i=e[1];r=a=n+i;s=!a?.5:i/a;e=[s*u.width,h()*u.height],l=e[0],o=e[1];t.r=r;t.sum=a;t.rate=s;t.L=n;t.R=i;t.cx=l;if(!(t.x!=null)){t.x=l;t.y=o}if(!(t._x!=null)){t._x=l;t._y=o}return t});this.rate=.85*Math.PI/(2*Math.sqrt(3))*Math.sqrt(u.width*u.height/this.valid.map(function(t){return Math.PI*Math.pow(t.r,2)}).reduce(function(t,e){return t+e},0));return this.valid.map(function(t,e){var n;return t.rr=(n=t.r*i.rate)>2?n:2})},render:function(){var t,n,e,r,i,a;t=this.binding,n=this.tint,e=this.rate,r=this.legendData;i=this.g.view.selectAll("g.pie").data(this.valid);i.exit().remove();i.enter().append("g").attr("class","pie data").each(function(){s.select(this).append("path");return s.select(this).append("path")});this.g.view.selectAll("g.pie").each(function(l,t){s.select(this).attr("transform","translate("+l.x+" "+l.y+")");return s.select(this).selectAll("path").attr("fill",function(t,e){return n.get(r[e].key)}).attr("d",function(t,e){var n,i,r,a,s;n=l.rr;i=n*Math.cos(l.rate*Math.PI);r=-n*Math.sin(l.rate*Math.PI);a=n*Math.sin(l.rate*Math.PI);s=l.rate>.5?e:1-e;return["M",i,r,"A",n,n,0,s,e,i,a,"L",0,0,"Z"].join(" ")})});a=this.g.view.selectAll("g.label").data(this.valid);a.exit().remove();a.enter().append("g").attr("class","label").each(function(t,e){var n=this;return[0,1].map(function(){return s.select(n).append("text")}).map(function(t){return t.attr("text-anchor","middle").attr("dominant-baseline","middle").style("pointer-event","none")})});this.g.view.selectAll("g.label").attr("transform",function(t,e){return"translate("+t.x+","+t.y+")"}).each(function(i,t){return s.select(this).selectAll("text").attr("dy",function(t,e){if(e===0){return"-.28em"}else{return".88em"}}).attr("opacity",i.rr*2<(i.sum.toFixed(2)+"").length*7?0:1).attr("fill",function(t,e){if(l.hcl(n.get(r[0])).l>60){return"#000"}else{return"#eee"}}).attr("font-size",function(t,e){if(e){return".9em"}else{return"1.1em"}}).text(function(t,e){var n;if(e===1){return i.name}n=i.L>i.R?s.format(".2s")(i.L/i.R)+":1":"1:"+s.format(".2s")(i.R/i.L);return n})});return this.legend.render()},tick:function(){var e,n,t,i;e=this.cfg.pad||5;n=this.vbox;if(!this.sim){t=true;this.fc=i=s.forceCollide().strength(.6).iterations(20).radius(function(t){return t.rr});this.fg=s.forceCenter().strength(.5);this.fb=r(function(t){return t.rr+e},function(t){return t.rr+e},function(t){return n.width-t.rr-e},function(t){return n.height-t.rr-e}).strength(.8);this.sim=s.forceSimulation().force("b",this.fb).force("collide",this.fc);this.sim.stop();this.sim.alpha(.9)}this.fg.x(n.width/2);this.fg.y(n.height/2);this.sim.nodes(this.valid);this.sim.tick(t?10:1);if(this.sim.alpha()<.01){this.stop()}this.valid.map(function(t){t._x=t._x+(t.x-t._x)*.1;return t._y=t._y+(t.y-t._y)*.1});this.g.view.selectAll("g.label").attr("transform",function(t,e){return"translate("+t._x+","+t._y+")"});return this.g.view.selectAll("g.pie").attr("transform",function(t,e){return"translate("+t._x+","+t._y+")"})}}};function import$(t,e){var n={}.hasOwnProperty;for(var i in e)if(n.call(e,i))t[i]=e[i];return t}</script></div>