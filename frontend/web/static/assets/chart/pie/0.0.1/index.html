<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:flex;justify-content:center;align-items:center}.pdl-layout>div[data-type=layout]>[data-name=view]{height:100%;margin-right:1em}.pdl-layout>div[data-type=layout]>[data-name=legend]{min-width:6em}.pdl-layout.legend-bottom>div[data-type=layout]{flex-direction:column}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"pie",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{value:"數值",name:"名稱",category:"分類",other:"其它"}}},init:function(t){var e,r,n,i;e=t.root,r=t.context,n=t.pubsub,i=t.t;return n.fire("init",{mod:mod({context:r,t:i})})}};mod=function(t){var e,r,n,f,i;e=t.context,r=t.t;n=e.chart,f=e.d3;return{sample:function(){return{raw:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30].map(function(t){return{val:(10*Math.random()).toFixed(2),c1:"A"+Math.ceil(Math.random()*7),c2:"B"+Math.ceil(Math.random()*4),c3:"C"+Math.ceil(Math.random()*4),name:"N:"+t}}),binding:{name:{key:"name"},category:[{key:"c1"},{key:"c2"},{key:"c3"}],value:{key:"val"}}}},config:(i=n.utils.config.from({preset:"default",legend:"legend"}),i.donut={percent:{type:"number",default:.7,min:0,max:1,step:.01},padding:{type:"number",default:.03,min:0,max:1,step:.01}},i),dimension:{name:{type:"NCO",name:"name",priority:10},value:{type:"R",name:"value",priority:20},category:{type:"C",name:"category",priority:25,multiple:true}},init:function(){var e,a=this;this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,f.select(a.layout.getGroup(t)).append("g")]}));this.tint=e=new n.utils.tint;this.tip=new n.utils.tip({root:this.root,accessor:function(t){var e,r,n,i;e=t.evt;if(!(e.target&&(r=f.select(e.target).datum()))){return null}n=isNaN(r.value)?"-":r.value.toFixed(2)+""+(a.binding.value.unit||"");return{name:r.name||(r.category?(i=r.category)[i.length-1]:"-"),value:n}},range:function(){return a.layout.getNode("view").getBoundingClientRect()}});this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return f.select(this).attr("fill",e.get(t.text))},cfg:{selectable:true}});this.legend.on("select",function(){a.parse();a.bind();a.resize();return a.render()});this.arc=f.arc().startAngle(0).endAngle(Math.PI/2);this.total={};return this.hover={}},destroy:function(){return this.tip.destroy()},parse:function(){var t,i,g,e,r,h,n,a,o,u,l;this.tint.reset();t=this.binding.category||[];i=this.all;this.all=g=[];for(e=0,r=t.length;e<r;++e){h=e;n={};this.data.map(c);g.push(s())}g.push(this.data.map(function(t){return import$({colorKey:t.category[0]||t.name},t)}));for(e=0,r=g.length;e<r;++e){h=e;u=g[h];u.sort(d)}g.map(function(t,r){return t.map(function(t,e){t._idx=e;return t._lv=r})});if(i){g.map(function(t,n){return t.map(function(t,e){var r;if(i[n]&&i[n][e]){return t.old=(r=i[n][e]).old,t.cur=r.cur,t}})})}l=this.all[0].map(function(t){return{text:t.colorKey,key:t.colorKey}});l.sort(function(t,e){if(t.text>e.text){return 1}else if(t.text<e.text){return-1}else{return 0}});return this.legend.data(l);function c(t){var e,r;e=t.category.slice(0,h+1);r=e.map(function(t){return((t||"")+"").replace(/\//g,"//")}).join("/");if(!n[r]){n[r]={category:e,colorKey:e[0]||t.name,value:0}}return n[r].value+=t.value||0}function s(){var t,e=[];for(a in t=n){o=t[a];e.push(o)}return e}function d(i,a){var t,e,o,r,n,u,l;for(t=0,e=h;t<e;++t){o=t;r=g[o].filter(c);n=g[o].filter(s);u=r.map(d).indexOf(i.category[o]);l=n.map(f).indexOf(a.category[o]);if(u===l){continue}return u-l}return a.value-i.value;function c(t){var e,r,n;for(e=0,r=o;e<r;++e){n=e;if(t.category[n]!==i.category[n]){return false}}return true}function s(t){var e,r,n;for(e=0,r=o;e<r;++e){n=e;if(t.category[n]!==a.category[n]){return false}}return true}function d(t){return t.category[o]}function f(t){return t.category[o]}}},bind:function(){var e=this;return this.all.map(function(t){return t.map(function(t){return t.picked=e.legend.isSelected(t.colorKey)})})},resize:function(){var t;this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",this.cfg.legend.position==="bottom");this.layout.update(false);t=this.layout.getBox("view");this.layout.getNode("view").style.width=t.height+"px";this.layout.update(false);return this.legend.config(this.cfg.legend)},render:function(){var t,i,o,a,p,m,u,l,e,r,n,c,y,s,d,v=this;t=this.binding,i=this.legend,o=this.arc,a=this.tint,p=this.all,m=this.cfg,u=this.hover;l=function(){return v.render()};e=this.layout.getBox("view");r=[e.width,e.height],n=r[0],c=r[1];y=Math.min(n,c);this.total.old=this.total.cur;this.total.cur=this.all[0].reduce(function(t,e){return t+(e.picked?e.value:0)},0)||1;if(!this.total.old){this.total.old=this.total.cur}p.map(function(t,e){var r,n,i,a,o,u,l,c,s,d,f,g,h=[];r=0;n=m.donut.percent*y/2;i=y/2;a=m.donut.padding*(i-n)/(p.length-1||1);o=(i-n)*(1-m.donut.padding)/(p.length||1);u=n+(o+a)*e;l=n+(o+a)*e+o;a=.002*a;for(c=0,s=t.length;c<s;++c){d=c;f=t[d];if(!f.old){f.old={s:(g=t[d-1])?g.old.e:0,e:0,r1:u,r2:u,rp:a}}if(f.cur){f.old=f.cur}f.cur={s:r,e:r+(f.picked?f.value:0),r1:u,r2:l,rp:a};f.old.angle={s:2*Math.PI*f.old.s/v.total.old,e:2*Math.PI*f.old.e/v.total.old};f.cur.angle={s:2*Math.PI*f.cur.s/v.total.cur,e:2*Math.PI*f.cur.e/v.total.cur};if(f.picked){h.push(r+=f.value)}}return h});s=function(i,a,t){return function(e){var t,r,n;o.innerRadius((a.r1-i.r1)*e+i.r1).outerRadius((a.r2-i.r2)*e+i.r2).padAngle((a.rp-i.rp)*e+i.rp);t=["s","e"].map(function(t){return(a.angle[t]-i.angle[t])*e+i.angle[t]}),r=t[0],n=t[1];v.arc.startAngle(r).endAngle(n);return v.arc()}};if(this.cfg!=null&&this.cfg.palette){this.tint.set(this.cfg.palette.colors.map(function(t){return t.value||t}))}e=this.layout.getBox("view");this.g.view.attr("transform","translate("+e.width/2+","+e.height/2+")");d=this.g.view.selectAll("g.ring").data(this.all);d.exit().remove();d.enter().append("g").attr("class","ring");return this.g.view.selectAll("g.ring").each(function(t,r){var e,n;e=f.select(this);n=e.selectAll("path.data").data(t,function(t){return t.name||t._idx});n.exit().remove();n.enter().append("path").attr("class","data").on("mouseover",function(t,e,r){u.item=e;return l()}).on("mouseout",function(t,e,r){u.item=null;return l()}).attr("opacity",function(t,e){return 0}).attr("fill",function(t,e){return a.get(t.colorKey||t._idx)});e.selectAll("path.data").transition().duration(350).attrTween("d",function(t,e){return s(t.old,t.cur,r)}).attr("fill",function(t,e){return a.get(t.colorKey||t._idx)}).attr("opacity",function(t,e){var r,n,i,a;if(!(r=u.item)){return 1}if(r.category){for(n=0,i=r.category.length;n<i;++n){a=n;if(t.category[a]!==r.category[a]){return.3}if(a===t.category.length-1){break}}if(t._lv===r._lv&&t!==r){return.3}return 1}else if(u.item.name===t.name){return 1}else{return.3}});return i.render()})}}};function import$(t,e){var r={}.hasOwnProperty;for(var n in e)if(r.call(e,n))t[n]=e[n];return t}</script></div>