<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(10em)}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=view]{grid-column:1}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:2;padding:0 .5em 0 .5em}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"voronoi-treemap",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[{name:"@zbryikt/voronoijs",version:"main",path:"index.min.js"}]},init:function(t){var e,i,r;e=t.root,i=t.context,r=t.pubsub;return r.fire("init",{mod:mod({context:i})}).then(function(t){return t[0]})}};mod=function(t){var e,h,f,c,g,i;e=t.context;h=e.d3,f=e.ldcolor,c=e.voronoi,g=e.chart;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100].map(function(t){return{name:"Node "+t,val:(Math.random()*10).toFixed(2),cat:"C-"+Math.floor(1+10*Math.random())}}),binding:{name:{key:"name"},area:{key:"val"},category:{key:"cat"}}}},config:(i=g.utils.config.from({preset:"default",label:"label",legend:"legend"}),i.voronoi={maxCount:{type:"number",min:1,max:200,step:1,default:100},preserve:{type:"choice",values:["Larger Value","Smaller Value","As Input Order"]}},i.border={color:{type:"color",default:"#fff"},strokeWidth:{type:"number",default:1,min:0,max:100,step:1}},i),dimension:{area:{type:"R",name:"area"},name:{type:"N",desc:"name"},category:{type:"N",desc:"category"}},init:function(){var e,t,r=this;this.tint=e=new g.utils.tint;this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,h.select(r.layout.getGroup(t))]}));this.layout.getGroup("view").appendChild(t=document.createElementNS("http://www.w3.org/2000/svg","g"));this.g.shape=h.select(t);this.siteBoxes=[];this.legend=new g.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return h.select(this).attr("fill",e.get(t.key))},cfg:{selectable:true}});this.legend.on("select",function(){r.parse();r.bind();r.resize();return r.render()});this.tip=new g.utils.tip({root:this.root,accessor:function(t){var e,i;e=t.evt;if(!(e.target&&(i=h.select(e.target).datum()))){return null}if(Array.isArray(i)){if(!r._sites){return}if(!(i.idx!=null)){return}if(!(i=r._sites[i.idx])){return}}return{name:i.name,value:r.fmt(i.area||0)+""+((r.binding.area||{}).unit||"")}},range:function(){return r.layout.getNode("view").getBoundingClientRect()}});return this.start()},parse:function(){var t;this.data.map(function(t){return t.key=t.name,t.value=t.area,t});this.partial=this.data.slice(0);if(this.cfg.voronoi.preserve==="Larger Value"){this.partial.sort(function(t,e){return e.value-t.value})}else if(this.cfg.voronoi.preserve==="Smaller Value"){this.partial.sort(function(t,e){return t.value-e.value})}this.partial=this.partial.slice(0,((t=this.cfg).voronoi||(t.voronoi={})).maxCount||100);this.total=this.partial.reduce(function(t,e){return t+e.area},0);this.cats=Array.from(new Set(this.partial.map(function(t){return t.category}))).filter(function(t){return t!=null});return this.legend.data(this.cats.map(function(t){return{key:t,text:t}}))},resize:function(){var t,e,i,r,n,a,s,o,l,u=this;this.fmt=g.utils.format.from(this.cfg.label.format);t=this.binding.category?this.partial.filter(function(t){return u.legend.isSelected(t.category)}):this.partial;this.parsed={children:h.nest().key(function(t){return t.category}).entries(t).map(function(t){return t.children=t.values,t})};e=this.layout.getBox("view");i=[e.width,e.height],r=i[0],n=i[1];r=n=Math.min(r,n);this.treemap=new c.Treemap(this.parsed,c.Polygon.create(r,n,60),r,n);a=this.treemap.getSites();s=this.g.shape.selectAll("path.data").data(this.treemap.getPolygons());s.exit().remove();s.enter().append("path").attr("class","data").each(function(t,e){return t.idx=e});this.g.shape.selectAll("path.data").attr("class",function(t,e){if(a[e].lv<=0){return"data group"}else{return"data"}});this.polygons=this.g.shape.selectAll("path.data");o=this.g.shape.selectAll("g.label").data(a);o.exit().remove();o.enter().append("g").attr("class","label").each(function(t,e){var i;i=h.select(this);i.append("text").attr("class","name").attr("font-size",".8em");i.append("text").attr("class","value");return i});this.sites=this.g.shape.selectAll("g.label");this.sites.attr("font-size",this.cfg.font.size);this.sites.each(function(t,e){return h.select(this).selectAll("text").data([t,t]).attr("text-anchor","middle").attr("dominant-baseline","center")});e=this.layout.getBox("view");i=[e.width,e.height],r=i[0],n=i[1];l=Math.min(r,n);this.legend.config(this.cfg.legend);this.legend.update();this.layout.update(false);this.g.shape.attr("transform","translate("+(r/2-l/2)+","+(n/2-l/2)+")");this.scale={x:h.scaleLinear().domain([0,r]).range([0,r]),y:h.scaleLinear().domain([0,n]).range([0,n]),color:h.interpolateTurbo};if(this.cfg!=null&&this.cfg.palette){this.scale.color=h.interpolateDiscrete(this.cfg.palette.colors.map(function(t){return f.web(t.value||t)}))}this.tint.set(this.cfg.palette);a=this.treemap.getSites();this.count=0;return this.gbox=this.svg.getBoundingClientRect()},render:function(t){var i,e,r,n,a,o,c,s=this;t==null&&(t=false);this._sites=i=this.treemap.getSites();e=this.treemap.getPolygons();r=[this.box.width,this.box.height],n=r[0],a=r[1];if(!t){this.legend.render();this.sites.selectAll(".name").attr("dy","0.88em").text(function(t){var e;e=(t.name||"")+"";return e;if(t.lv>0){return e.substring(0,7)+(e.length>7?"...":"")}else{return""}}).attr("fill",function(t,e){if(f.hcl(s.tint.get(t.category)).l>60){return"#000"}else{return"#eee"}}).style("pointer-events","none");this.sites.selectAll(".value").attr("dy","-0.28em").text(function(t){if(t.lv>0){return s.fmt(t.area||0)}else{return""}}).attr("fill",function(t,e){if(f.hcl(s.tint.get(t.category)).l>60){return"#000"}else{return"#eee"}}).style("pointer-events","none");this.siteBoxes=o=[];this.sites.each(function(t,e){return o.push(this.getBoundingClientRect())});this.polygons.attr("fill",function(t,e){return s.tint.get(i[e].category)}).attr("stroke",this.cfg.border.color).attr("stroke-width",this.cfg.border.strokeWidth)}o=this.siteBoxes;c=[];this.polygons.data(e).attr("d",function(t,e){var i,r,n,a,s,o,l,u,h;t.idx=e;if(!(t&&t.length)){c.push({});return""}i=[["M",t[0].x,t[0].y]];r=[{x:t[0].x,y:t[0].y},{x:t[0].x,y:t[0].y}],n=r[0],a=r[1];for(s=0,o=t.length;s<o;++s){l=s;r=[t[l].x,t[l].y],u=r[0],h=r[1];if(n.x>u){n.x=u}if(a.x<u){a.x=u}if(n.y>h){n.y=h}if(a.y<h){a.y=h}i.push(["L",u,h])}i.push(["L",t[0].x,t[0].y]);c.push({x:n.x,y:n.y,width:a.x-n.x,height:a.y-n.y});return i.map(function(t){return t.join(" ")}).join(" ")});this.polygons.attr("opacity",function(t,e){var i,r,n,a;i=c[e];r=i.x+i.width/2;n=i.y+i.height/2;a=isNaN(i.x+i.y+i.width+i.height);if(a){return 0}else{return 1}});return this.sites.each(function(t,e){var r,n,i,a,s;r=c[e];n=o[e];if(!n){n=this.getBoundingClientRect()}i=r.x+r.width/2;a=r.y+r.height/2;s=isNaN(i)||isNaN(a);return h.select(this).attr("transform",function(){var t,e,i;t=r.x+r.width/2;e=r.y+r.height/2;if(s){i=[-1e4,-1e4],t=i[0],e=i[1]}return"translate("+t+", "+e+")"}).attr("opacity",function(){var t,e,i;if(s){return 0}else{return(t=1-6*((e=n.width/((i=r.width)>0?i:0)-1)>0?e:0))>0?t:0}}).style("pointer-events",function(){if(s){return"none"}else{return""}})})},tick:function(){if(!this.treemap){return}this.count=(this.count||0)+1;if(this.count<100){this.treemap.compute();return this.render(true)}}}};</script></div>