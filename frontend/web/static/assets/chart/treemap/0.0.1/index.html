<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="unit"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(10em);grid-template-rows:1fr fit-content(1em)}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=view]{grid-area:1/1}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-area:1/2/span 2;padding:0 .5em 0 .5em}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=unit]{grid-area:2/1;line-height:1em;text-align:right;padding:.25em 0;white-space:nowrap}.pdl-layout.legend-bottom>div[data-type=layout]{grid-template-columns:1fr fit-content(1em);grid-template-rows:1fr fit-content(3em)}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=view]{grid-area:1/1 /auto/span 2}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{grid-area:2/1;padding-top:1em}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=unit]{grid-area:2/2;padding-top:1em}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"treemap",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{other:"其它",unit:"單位"}}},init:function(t){var e,n,i,r;e=t.root,n=t.context,i=t.pubsub,r=t.t;return i.fire("init",{mod:mod({root:e,context:n,t:r})})}};mod=function(t){var i,e,a,o,u,n,d;i=t.root,e=t.context,a=t.t;o=e.chart,u=e.d3,n=e.ldcolor,d=e.wrapSvgText;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50].map(function(t){return{val:Math.random().toFixed(2),cat:Math.floor(1+6*Math.random())}}),binding:{color:{key:"cat"},area:{key:"val",unit:"MB"},name:{key:"cat"},category:{key:"cat"}}}},config:import$(o.utils.config.from({preset:"default",legend:"legend",label:"label"}),{unit:{position:{type:"choice",values:["inner","outside","none"]}}}),dimension:{color:{type:"RC",name:"顏色",priority:4},area:{type:"R",name:"面積",priority:1},name:{type:"NC",name:"名稱",priority:2},category:{type:"C",name:"分類",priority:3}},init:function(){var e,t,n,r=this;this.tint=e=new o.utils.tint;this.g=Object.fromEntries(["view","unit","legend"].map(function(t){return[t,u.select(r.layout.getGroup(t))]}));this.textRenderer=t=document.createElement("div");import$(t.style,{textAlign:"right",fontSize:"0.9em",padding:".5em .5em",lineHeight:"1.1em",whiteSpace:"pre-line",display:"inline-block",position:"absolute",top:0,left:0,opacity:0,pointerEvents:"none",userSelect:"none",zIndex:0});i.appendChild(t);this.legend=new o.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return u.select(this).attr("fill",e.get(t.key))},direction:((n=this.cfg).legend||(n.legend={})).position==="bottom"?"horizontal":"vertical",cfg:{selectable:true}});this.legend.on("select",function(){r.bind();r.resize();return r.render()});return this.tip=new o.utils.tip({root:this.root,accessor:function(t){var e,n,i;e=t.evt;if(!(e.target&&(n=u.select(e.target).datum()))){return null}i=isNaN(n.data.area)?"-":r.fmt(n.data.area)+""+(r.binding.area.unit||"");return{name:n.data.name,value:i}},range:function(){return r.layout.getNode("view").getBoundingClientRect()}})},destroy:function(){return this.tip.destroy()},parse:function(){var n,i,r;this.tint.reset();n={};this.data.map(function(t,e){t.id="name-"+e;if(!t.category||t.category===""){return t.category=a("other")}});if(!this.binding.category){this.data.map(function(t){return t.category="root-1"})}this.data.map(function(t){return n[t.category]={id:t.category,category:"root"}});this.cats=Array.from(new Set(this.data.map(function(t){return t.category}))).filter(function(t){return t!=="root-1"});this.data=this.data.concat(function(){var t,e=[];for(i in t=n){r=t[i];e.push(r)}return e}(),[{id:"root"}]);return this.legend.data(this.cats.map(function(t){return{key:t,text:t}}))},bind:function(){var t,e,n=this;t=this.data.filter(function(t){var e;return t.id==="root"||((e=t.category)==="root"||e==="root-1")||n.legend.isSelected(t.category)});e=u.stratify().id(function(t){return t.id}).parentId(function(t){return t.category});return this.ret=e(t)},resize:function(){var t,e,n,i,r;this.fmt=o.utils.format.from(this.cfg.label.format);this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",((t=this.cfg).legend||(t.legend={})).position==="bottom");this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);this.unit={inner:((t=this.cfg).unit||(t.unit={})).position==="inner"?this.binding.area.unit||"":"",outer:(t=((e=this.cfg).unit||(e.unit={})).position)==="inner"||t==="none"?"":this.binding.area.unit?a("unit")+": "+(this.binding.area.unit||""):""};n=this.layout.getNode("unit");n.style.display=!this.unit.outer?"none":"";n.textContent=this.unit.outer;this.legend.config(this.cfg.legend);this.legend.update();this.layout.update(false);this.ret.sum(function(t){return t.area});i=this.layout.getBox("view");r=u.treemap().padding(1).size([i.width,i.height])(this.ret);this.nodes=this.ret.leaves().filter(function(t){return t.data._raw});this.nodes.map(function(t){return t._raw=t.data._raw});return this.extent=u.extent(this.nodes.map(function(t){return t.value}))},render:function(){var t,r,e,n,a,i,o,u,s,c=this;t=this.cfg,r=this.unit,e=this.binding,n=this.layout,a=this.textRenderer,i=this.tint,o=this.fmt;i.set(t.palette);this.g.unit.call(function(){var t,e;t=n.getNode("unit");e=d({node:t,useRange:true});c.g.unit.node().textContent="";return c.g.unit.node().appendChild(e)});u=this.g.view.selectAll("rect.data").data(this.nodes,function(t){return t.data._idx});u.exit().remove();u.enter().append("rect").attr("class","data").attr("x",function(t){return(t.x1+t.x0)/2}).attr("y",function(t){return(t.y1+t.y0)/2}).attr("width",function(){return 0}).attr("height",function(){return 0}).attr("fill",function(t){return i.get(t.data.color||t.data.category)}).style("opacity",0);this.g.view.selectAll("rect").transition().duration(350).attr("x",function(t){return t.x0}).attr("y",function(t){return t.y0}).attr("width",function(t){return t.x1-t.x0}).attr("height",function(t){return t.y1-t.y0}).attr("fill",function(t){var e;e=(t.value-c.extent[0])/(c.extent[1]-c.extent[0])-.5;return i.get(t.data.color||t.data.category)}).style("opacity",1);s=this.g.view.selectAll("g.label").data(this.nodes,function(t){return t.data._idx});s.exit().remove();s.enter().append("g").attr("class","label data").attr("transform",function(t,e){return"translate("+t.x0+","+t.y0+")"}).attr("opacity",0).style("pointer-events","none").style("cursor","pointer");this.g.view.selectAll("g.label").attr("font-size","0.9em").attr("opacity",0).each(function(t,e){var n,i;a.style.width=t.x1-t.x0+"px";n=isNaN(t.data.area)?"-":o(t.data.area);a.innerHTML="<div>"+(t.data.name||"")+"</div>\n<div>"+n+r.inner+"</div>";i=d({node:a,useRange:true});this.textContent="";return this.appendChild(i)}).transition().duration(350).attr("transform",function(t,e){return"translate("+t.x0+","+t.y0+")"}).attr("fill",function(t){return i.text(t.data.color||t.data.category)}).attr("opacity",function(t,e){var n;n=this.getBBox();return n.width>t.x1-t.x0||n.height>t.y1-t.y0?0:1});return this.legend.render()}}};function import$(t,e){var n={}.hasOwnProperty;for(var i in e)if(n.call(e,i))t[i]=e[i];return t}</script></div>