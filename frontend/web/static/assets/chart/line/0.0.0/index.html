<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="yaxis">&nbsp;</div><div class="pdl-cell" data-name="view"></div><div class="pdl-cell"></div><div class="pdl-cell" data-name="xaxis">&nbsp;</div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">[data-name=xaxis]{font-size:.8em}[data-name=yaxis]{font-size:.8em}.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:fit-content(2em) 1fr fit-content(7em);grid-template-rows:1fr fit-content(1em);padding:0 .5em}.pdl-layout>div[data-type=layout] .pdl-cell[data-name=legend]{padding-left:1em;grid-column:3;grid-row:1/span 2}.pdl-layout.legend-below>div[data-type=layout]{grid-template-columns:2em 1fr;grid-template-rows:1fr fit-content(2em) fit-content(3em)}.pdl-layout.legend-below>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1/span 2;grid-row:3}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"line",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{"y axis":"Y軸","x axis":"X軸",rank:"順位"}}},init:function(t){var e,i,r,n;e=t.root,i=t.context,r=t.pubsub,n=t.t;return r.fire("init",{mod:mod({context:i,t:n})})}};mod=function(t){var e,N,k,w,i,r,n;e=t.context,N=t.t;k=e.d3,w=e.chart,i=e.axis,r=e.format;n=4;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20].map(function(i){var r;r={};(function(){var t,e,i=[];for(t=1,e=n;t<=e;++t){i.push(t)}return i})().map(function(t){var e;return r["val"+t]=(e=+(t*Math.random()*(10-Math.abs(10-i))+i).toFixed(2))>0?e:0});r.order=i;return r}),binding:{value:function(){var t,e,i=[];for(t=1,e=n;t<=e;++t){i.push(t)}return i}().map(function(t){return{key:"val"+t}}),order:{key:"order"}}}},config:{mode:{type:"choice",values:["line","area","streamgraph","bump","diff"],default:"line"},stack:{type:"boolean"},line:{type:"choice",values:["curve","linear"],default:"linear"},showDot:{type:"boolean",default:true}},dimension:{value:{type:"R",name:"y axis",multiple:true},order:{type:"ON",name:"x axis"}},init:function(){var t,e,m=this;t=k.select(this.svg);["view","yaxis","xaxis","legend"].map(function(t){return(m.g||(m.g={}))[t]=k.select(m.layout.getGroup(t))});this.tint=e=new w.utils.tint;this.line=k.line().defined(function(t){return!isNaN(t.y1)}).x(function(t){return m.scale.x(t.x)}).y(function(t){return m.scale.y(t.y1)});this.area=k.area().defined(function(t){return!isNaN(t.y1)&&!isNaN(t.y0)}).x(function(t){return m.scale.x(t.x)}).y0(function(t){return m.scale.y(t.y0)}).y1(function(t){return m.scale.y(t.y1)});this.xaxis=new w.utils.axis({layout:this.layout,name:"xaxis",direction:"bottom"});this.yaxis=new w.utils.axis({layout:this.layout,name:"yaxis",direction:"left"});this.tip=new w.utils.tip({root:this.root,range:function(){return m.layout.getNode("view").getBoundingClientRect()}});this._evthdr={};this.root.addEventListener("mouseout",this._evthdr.out=function(t){return m.tip.hide().now()});this.root.addEventListener("mousemove",this._evthdr.move=function(t){var e,i,r,n,a,s,o,u,l,c,d,h,f,y,p,g,x,v;e=t.clientX-m.layout.getNode("view").getBoundingClientRect().x;i=t.clientY-m.layout.getNode("view").getBoundingClientRect().y;if(m.cfg.mode==="streamgraph"){r=k.select(t.target).datum();if(!r){return}n=r.bind;a={d:-1,p:null};for(s=0,o=r.pts.length;s<o;++s){u=s;l=r.pts[u];if(isNaN(l.y1)||isNaN(l.x)){continue}c=Math.abs(m.scale.x(l.x)-e);if(a.d<0||a.d>c){a.d=c;a.p=l}}d=a.p}else{a={d:-1,p:null,series:null};for(s=0,o=m.parsed.length;s<o;++s){h=s;r=m.parsed[h];for(f=0,y=r.pts.length;f<y;++f){u=f;l=r.pts[u];if(isNaN(l.y1)||isNaN(l.x)){continue}c=Math.abs(m.scale.x(l.x)-e);p=Math.abs(m.scale.y(l.y1)-i);g=Math.pow(c,2)+Math.pow(p,2);if(a.d<0||a.d>g){a.d=g;a.p=l;a.series=r}}}if(!(a.p&&a.d&&a.series)){return}n=a.series.bind;d=a.p}x={name:(n?n.name||n.key||"":void 8)+" /\n"+(d.data.orderText||d.data.order||d.x)+(m.binding.order.unit||""),value:isNaN(d.v)?"-":d.v.toFixed(2)+""+(n?n.unit||"":"")};v={x:m.scale.x(d.x),y:m.scale.y(d.y)};return m.tip.render({data:x,evt:t,box:v})});this.legend=new w.utils.legend({layout:this.layout,root:this.root,name:"legend",shape:function(t){return k.select(this).attr("fill",e.get(t.text))},direction:"vertical",cfg:{selectable:true}});this.legend.on("select",function(){m.bind();m.resize();return m.render()});return this.scale={x:k.scaleLinear(),y:k.scaleLinear()}},destroy:function(){this.root.removeEventListener("mouseout",this._evthdr.out);this.root.removeEventListener("mousemove",this._evthdr.move);return this.tip.destroy()},parse:function(){this.data.map(function(t,e){t.orderText=""+(!(t.order!=null)?e:t.order);return t._order=!(t.order!=null)||isNaN(+t.order)?e:+t.order});this.data.sort(function(t,e){if(t._order>e._order){return 1}else if(t._order===e._order){return 0}else{return-1}});return this.legend.data(this.binding.value.map(function(t){return{key:t.key,text:t.key}}))},bind:function(){var t,e,i,r,n,a,s,o,u,l,c,d,h,f,y,p,g=this;t=this.binding.value.map(function(t,e){return{b:t,i:e}}).filter(function(t,e){return g.legend.isSelected(t.b.key)});if(this.cfg.mode==="bump"){this.parsed=[];e=this.data.map(function(t){var e,i;e=import$({},t);i=e.value.map(function(t,e){return{i:e,v:g.legend.isSelected(g.binding.value[e].key)?t:NaN}});i.sort(function(t,e){if(isNaN(t.v)&&isNaN(e.v)){return 0}else if(isNaN(e.v)){return-1}else if(isNaN(t.v)){return 1}return e.v-t.v});i.map(function(t,e){return t.r=e+1});i.sort(function(t,e){return t.i-e.i});e.value=i.map(function(t){if(isNaN(t.v)){return NaN}else{return t.r}});e.originalValue=i.map(function(t){return t.v});return e})}e=e||this.data;if(this.cfg.mode==="streamgraph"){i=e.map(function(t){var e,i,r,n;e=0;for(i=0,r=t.value.length;i<r;++i){n=i;e+=t.value[n]}return e});r=[Math.min.apply(Math,i),Math.max.apply(Math,i)],n=r[0],a=r[1]}else{r=[e.map(function(){return 0}),0,0],i=r[0],n=r[1],a=r[2]}this.parsed=[];s=e.map(function(){return 0});for(o=0,u=t.length;o<u;++o){l=o;r=[l>0?t[l-1]:null,t[l]],c=r[0],d=r[1];h=e.map(x);this.parsed.push({pts:(e||this.data).map(v),bind:d.b,color:d.b.name||d.b.key});if(this.cfg.stack&&this.cfg.mode!=="bump"||((r=this.cfg.mode)==="streamgraph"||r==="area")){s=h}}this.bars=[];if(this.cfg.mode==="diff"){for(o=0,u=e.length;o<u;++o){l=o;f=e[l];r=f.value[1]>f.value[0]?[f.value[0],f.value[1]]:[f.value[1],f.value[0]],y=r[0],p=r[1];this.bars.push({y0:f.value[0],y1:f.value[1],yl:y,yh:p,x:f._order})}return this.parsed=[this.parsed[0],this.parsed[1]]}function x(t,e){return t.value[d.i]+s[e]}function v(t,e){return{data:t,y0:s[e]-i[e]/2+(a-n)/2,y1:h[e]-i[e]/2+(a-n)/2,x:t._order,v:t.originalValue?t.originalValue[d.i]:t.value[d.i]}}},resize:function(){var t,e,i,r,n,a,s,o,u,l,c,d,h,f,y,p,g,x,v,m,b=[];this.line.curve(this.cfg.line==="curve"?k.curveCatmullRom:k.curveLinear);this.area.curve(this.cfg.line==="curve"?k.curveCatmullRom:k.curveLinear);this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);t=[0,0],e=t[0],i=t[1];for(r=0,n=this.parsed.length;r<n;++r){a=r;for(s=0,o=this.parsed[a].pts.length;s<o;++s){u=s;l=this.parsed[a].pts[u];if(!isNaN(l.y0)&&e>l.y0){e=l.y0}if(!isNaN(l.y1)&&e>l.y1){e=l.y1}if(!isNaN(l.y0)&&i<l.y0){i=l.y0}if(!isNaN(l.y1)&&i<l.y1){i=l.y1}}}this.extent={x:k.extent(this.data,function(t){return t._order}),y:[this.cfg.mode==="bump"?e>1?e:1:e,i===e?e+1:i]};this.scale.x.domain(this.extent.x);this.scale.y.domain(this.cfg.mode==="bump"?[this.extent.y[1],this.extent.y[0]]:this.extent.y);t=[this.box.width,this.box.height],c=t[0],d=t[1];h=(t=Math.ceil(this.layout.getBox("yaxis").height/40))>2?t:2;f=this.cfg.mode==="bump"?function(){var t,e,i,r=[];for(t=1,e=(i=this.parsed.length||1)>1?i:1;t<=e;++t){r.push(t)}return r}.call(this):this.scale.y.ticks((t=((y=this.cfg).yaxis||(y.yaxis={})).tickCount||4)<h?t:h);p=w.utils.format.auto(f);this.legend.config(this.cfg.legend);this.legend.update();this.yaxis.config(this.cfg.yaxis);this.yaxis.ticks(f);this.yaxis.scale(this.scale.y);if(this.cfg.mode==="bump"){this.yaxis.caption(N("rank"))}else{if(this.parsed.length>1){g=Array.from(new Set(this.parsed.map(function(t){return t.bind.unit}))).filter(function(t){return t});if(g.length>1){this.yaxis.caption("")}else{this.yaxis.caption(g[0]||"")}}else{x=(this.parsed[0]||{}).bind||{};this.yaxis.caption((x.name||x.key||"")+(x.unit?"("+x.unit+")":""))}}this.xaxis.config(this.cfg.xaxis);this.xaxis.ticks(this.data.map(function(t){return{v:t._order,t:t.orderText}}));this.xaxis.scale(this.scale.x);this.xaxis.caption((this.binding.order.name||this.binding.order.key)+(this.binding.order.unit?"("+this.binding.order.unit+")":""));for(r=0;r<2;++r){a=r;this.layout.update(false);v=this.layout.getBox("view");t=[v.width,v.height],c=t[0],d=t[1];this.tint.set(this.cfg.palette);m=this.cfg.dotSize||3;this.scale.x.range([0,c-m]);this.scale.y.range([d,m]);this.xaxis.render();b.push(this.yaxis.render())}return b},render:function(){var r,n,a,s,t,e,i,o,u,l,c=this;r=this.scale,n=this.tint,a=this.extent;s=this.cfg.dotSize||3;t=this.layout.getBox("view");e=this.layout.getBox("yaxis");i=this.g.view.selectAll("path.data").data(this.cfg.mode==="diff"?[]:this.parsed,function(t){return t.bind.key});i.exit().remove();i.enter().append("path").attr("class","data").attr("fill","none").attr("d",function(t,e){var i;if((i=c.cfg.mode)==="streamgraph"||i==="area"){return c.area(t.pts)}else{return c.line(t.pts)}}).attr("stroke",function(t,e){return c.tint.get(t.color)}).attr("stroke-width",1);this.g.view.selectAll("path.data").transition().duration(150).style("opacity",function(t,e){if(c.legend.isSelected(t.bind.key)){return 1}else{return.3}}).attr("d",function(t,e){var i;if((i=c.cfg.mode)==="streamgraph"||i==="area"){return c.area(t.pts)}else{return c.line(t.pts)}}).attr("stroke",function(t,e){return c.tint.get(t.color)}).attr("fill",function(t,e){var i;if((i=c.cfg.mode)==="streamgraph"||i==="area"){return c.tint.get(t.color)}else{return"none"}}).attr("fill-opacity",function(){return"0.5"});o=!this.cfg.showDot?[]:this.parsed;u=this.g.view.selectAll("g.dot").data(o,function(t){return t.bind.key});u.exit().remove();u.enter().append("g").attr("class","dot");this.g.view.selectAll("g.dot").style("opacity",function(t,e){if(c.legend.isSelected(t.bind.key)){return 1}else{return.3}}).each(function(t,e){var i;i=k.select(this).selectAll("circle.dot").data(t.pts);i.exit().remove();i.enter().append("circle").attr("class","dot").attr("r",s).attr("fill","#fff").attr("stroke",n.get(t.bind.name||t.bind.key));k.select(this).selectAll("circle.dot").filter(function(t,e){return isNaN(t.y1)}).attr("cx",function(t,e){if(isNaN(r.x(t.x))){return r.x(a.x[0])}else{return r.x(t.x)}}).attr("cy",function(t,e){return r.y(a.y[0])}).transition(150).attr("opacity",0);return k.select(this).selectAll("circle.dot").filter(function(t,e){return!isNaN(t.y1)}).attr("cx",function(t,e){return r.x(t.x)}).attr("cy",function(t,e){return r.y(t.y1)}).attr("r",s).attr("fill",n.get(t.color)).attr("stroke",n.get(t.color)).transition(150).attr("opacity",1)});l=this.g.view.selectAll("rect.data").data(this.bars);l.exit().remove();l.enter().append("rect").attr("class","data").attr("x",function(t,e){return r.x(t.x)-s/4}).attr("y",function(t,e){return r.y(t.yh)}).attr("width",0).attr("height",0).attr("opacity",0);this.g.view.selectAll("rect.data").transition().duration(150).attr("x",function(t,e){return r.x(t.x)-s/4}).attr("y",function(t,e){return r.y(t.yh)}).attr("width",s/2).attr("height",function(t,e){return Math.abs(r.y(t.yh)-r.y(t.yl))}).attr("fill",function(t,e){if(t.y1>t.y0>0){return"#09f"}else{return"#f90"}}).attr("opacity",1);this.legend.render();this.xaxis.render();return this.yaxis.render()}}};function import$(t,e){var i={}.hasOwnProperty;for(var r in e)if(i.call(e,r))t[r]=e[r];return t}</script></div>