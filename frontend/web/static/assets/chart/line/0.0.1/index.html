<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="yaxis">&nbsp;</div><div class="pdl-cell" data-name="xaxis">&nbsp;</div><div class="pdl-cell" data-name="view"></div><div class="pdl-cell"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">[data-name=xaxis]{font-size:.8em}[data-name=yaxis]{font-size:.8em}.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:fit-content(2em) 1fr fit-content(7em);grid-template-rows:1fr fit-content(1em);padding:0 .5em}.pdl-layout>div[data-type=layout] .pdl-cell[data-name=xaxis]{grid-column:2;grid-row:2/span 1}.pdl-layout>div[data-type=layout] .pdl-cell[data-name=view]{grid-column:2;grid-row:1/span 1}.pdl-layout>div[data-type=layout] .pdl-cell[data-name=legend]{padding-left:1em;grid-column:3;grid-row:1/span 2}.pdl-layout.legend-bottom>div[data-type=layout]{grid-template-columns:fit-content(2em) 1fr;grid-template-rows:1fr fit-content(2em) fit-content(3em)}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=xaxis]{grid-column:2;grid-row:2/span 1}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=view]{grid-column:2;grid-row:1/span 1}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1/span 2;grid-row:3}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"line",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{"y axis":"Y軸","x axis":"X軸",rank:"順位"}}},init:function(t){var e,i,r,n;e=t.root,i=t.context,r=t.pubsub,n=t.t;return r.fire("init",{mod:mod({context:i,t:n})})}};mod=function(t){var e,M,_,A,i,r,n,a;e=t.context,M=t.t;_=e.d3,A=e.chart,i=e.axis,r=e.format;n=4;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20].map(function(i){var r;r={};(function(){var t,e,i=[];for(t=1,e=n;t<=e;++t){i.push(t)}return i})().map(function(t){var e;return r["val"+t]=(e=+(t*Math.random()*(10-Math.abs(10-i))+i).toFixed(2))>.1?e:.1});r.order=i;return r}),binding:{value:function(){var t,e,i=[];for(t=1,e=n;t<=e;++t){i.push(t)}return i}().map(function(t){return{key:"val"+t}}),order:{key:"order"}}}},config:(a=A.utils.config.from({preset:"default",legend:"legend",label:"label",xaxis:"axis",yaxis:"axis"}),a.mode={type:"choice",values:["line","area","streamgraph","bump","diff"],default:"line"},a.stack={type:"boolean"},a.area={opacity:{type:"number",default:.5,min:.01,max:1,step:.01},offset:{type:"number",default:0,min:0,max:1,step:.01},percent:{type:"boolean",default:false}},a.line={mode:{type:"choice",values:["curve","linear"],default:"linear"},strokeWidth:{type:"number",default:1,min:0,max:100,step:.5},cap:{type:"choice",values:["butt","round","square"],default:"round"}},a.diff={positive:{type:"color",default:"#09f"},negative:{type:"color",default:"#f90"}},a.dot={show:{type:"boolean",default:true},strokeWidth:{type:"number",default:1,min:0,max:100,step:.5},fill:{type:"boolean",default:true},size:{type:"number",default:3,min:1,max:100,step:.5}},a),dimension:{value:{type:"R",name:"y axis",multiple:true},order:{type:"ON",name:"x axis"}},init:function(){var t,e,v=this;t=_.select(this.svg);["yaxis","xaxis","view","legend"].map(function(t){return(v.g||(v.g={}))[t]=_.select(v.layout.getGroup(t))});["diff","line","dot"].map(function(t){return v.g[t]=v.g.view.append("g")});this.tint=e=new A.utils.tint;this.line=_.line().defined(function(t){return!isNaN(t.y1)}).x(function(t){return v.scale.x(t.x)}).y(function(t){return v.scale.y(t.y1)});this.area=_.area().defined(function(t){return!isNaN(t.y1)&&!isNaN(t.y0)}).x(function(t){return v.scale.x(t.x)}).y0(function(t){return v.scale.y(t.y0)}).y1(function(t){return v.scale.y(t.y1)});this.xaxis=new A.utils.axis({layout:this.layout,name:"xaxis",direction:"bottom"});this.yaxis=new A.utils.axis({layout:this.layout,name:"yaxis",direction:"left"});this.tip=new A.utils.tip({root:this.root,range:function(){return v.layout.getNode("view").getBoundingClientRect()}});this._evthdr={};this.root.addEventListener("mouseout",this._evthdr.out=function(t){return v.tip.hide().now()});this.root.addEventListener("mousemove",this._evthdr.move=function(t){var e,i,r,n,a,s,o,u,l,d,c,f,h,p,y,g,m,x;e=t.clientX-v.layout.getNode("view").getBoundingClientRect().x;i=t.clientY-v.layout.getNode("view").getBoundingClientRect().y;if(v.cfg.mode==="streamgraph"){r=_.select(t.target).datum();if(!r){return}n=r.bind;a={d:-1,p:null};for(s=0,o=r.pts.length;s<o;++s){u=s;l=r.pts[u];if(isNaN(l.y1)||isNaN(l.x)){continue}d=Math.abs(v.scale.x(l.x)-e);if(a.d<0||a.d>d){a.d=d;a.p=l}}c=a.p}else{a={d:-1,p:null,series:null};for(s=0,o=v.parsed.length;s<o;++s){f=s;r=v.parsed[f];for(h=0,p=r.pts.length;h<p;++h){u=h;l=r.pts[u];if(isNaN(l.y1)||isNaN(l.x)){continue}d=Math.abs(v.scale.x(l.x)-e);y=Math.abs(v.scale.y(l.y1)-i);g=Math.pow(d,2)+Math.pow(y,2);if(a.d<0||a.d>g){a.d=g;a.p=l;a.series=r}}}if(!(a.p&&a.d&&a.series)){return}n=a.series.bind;c=a.p}m={name:(n?n.name||n.key||"":void 8)+" /\n"+(c.data.orderText||c.data.order||c.x)+((v.binding.order||{}).unit||""),value:isNaN(c.v)?"-":v.fmt(c.v)+""+(n?n.unit||"":"")};x={x:v.scale.x(c.x),y:v.scale.y(c.y)};return v.tip.render({data:m,evt:t,box:x})});this.legend=new A.utils.legend({layout:this.layout,root:this.root,name:"legend",shape:function(t){return _.select(this).attr("fill",e.get(t.text))},direction:"vertical",cfg:{selectable:true}});this.legend.on("select",function(){v.bind();v.resize();return v.render()});return this.scale={x:_.scaleLinear(),y:_.scaleLinear()}},destroy:function(){this.root.removeEventListener("mouseout",this._evthdr.out);this.root.removeEventListener("mousemove",this._evthdr.move);return this.tip.destroy()},parse:function(){this.data.map(function(t,e){t.orderText=""+(!(t.order!=null)?e:t.order);return t._order=!(t.order!=null)||isNaN(+t.order)?e:+t.order});return this.data.sort(function(t,e){if(t._order>e._order){return 1}else if(t._order===e._order){return 0}else{return-1}})},bind:function(){var t,e,i,r,n,a,s,o,u,l,d,c,f,h,p,y,g,m,x=this;this.legend.config(import$(import$({},this.cfg.legend),this.cfg.mode==="diff"?{selectable:false}:{}));t=this.binding.value||[];this.legend.data((this.cfg.mode==="diff"?[t[0],t[1]].filter(function(t){return t}):this.binding.value||[]).map(function(t){return{key:t.key,text:t.key}}));e=t.map(function(t,e){return{b:t,i:e}}).filter(function(t,e){return x.legend.isSelected(t.b.key)});if(this.cfg.mode==="bump"){this.parsed=[];i=this.data.map(function(t){var e,i;e=import$({},t);i=e.value.map(function(t,e){return{i:e,v:x.legend.isSelected(x.binding.value[e].key)?t:NaN}});i.sort(function(t,e){if(isNaN(t.v)&&isNaN(e.v)){return 0}else if(isNaN(e.v)){return-1}else if(isNaN(t.v)){return 1}return e.v-t.v});i.map(function(t,e){return t.r=e+1});i.sort(function(t,e){return t.i-e.i});e.value=i.map(function(t){return t.r});e.originalValue=i.map(function(t){return t.v});return e})}i=i||this.data;if(this.cfg.mode==="streamgraph"){r=i.map(function(t){var e,i,r,n;e=0;for(i=0,r=t.value.length;i<r;++i){n=i;e+=t.value[n]}return e});n=[Math.min.apply(Math,r),Math.max.apply(Math,r)],a=n[0],s=n[1]}else{n=[i.map(function(){return 0}),0,0],r=n[0],a=n[1],s=n[2]}this.parsed=[];o=i.map(function(){return 0});if(this.cfg.mode==="area"&&this.cfg.stack&&this.cfg.area.percent){u=i.map(function(i){return e.reduce(function(t,e){return t+i.value[e.i]},0)||1})}else{u=i.map(function(){return 1})}for(l=0,d=e.length;l<d;++l){c=l;n=[c>0?e[c-1]:null,e[c]],f=n[0],h=n[1];p=i.map(v);this.parsed.push({pts:(i||this.data).map(b),bind:h.b,color:h.b.name||h.b.key});if(this.cfg.stack&&!((n=this.cfg.mode)==="bump"||n==="diff")||this.cfg.mode==="streamgraph"){o=p}}this.bars=[];if(this.cfg.mode==="diff"){for(l=0,d=i.length;l<d;++l){c=l;y=i[c];n=!(y.value!=null)?[undefined,undefined]:y.value[1]>y.value[0]?[y.value[0],y.value[1]]:[y.value[1],y.value[0]],g=n[0],m=n[1];if(isNaN(g)||isNaN(m)){continue}this.bars.push({y0:y.value[0],y1:y.value[1],yl:g,yh:m,x:y._order})}return this.parsed=!this.parsed[1]?[]:[this.parsed[0],this.parsed[1]]}function v(t,e){return o[e]+t.value[h.i]/u[e]}function b(t,e){return{data:t,y0:o[e]-r[e]/2+(s-a)/2,y1:p[e]-r[e]/2+(s-a)/2,x:t._order,v:t.originalValue?t.originalValue[h.i]:t.value[h.i]}}},resize:function(){var t,e,i,r,n,a,s,o,u,l,d,c,f,h,p,y,g,m,x,v,b,k,N,w=[];this.fmt=A.utils.format.from(this.cfg.label.format);this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",this.cfg.legend.position==="bottom");t=this.root.querySelector(".pdl-layout div[data-type=layout]");t.style.padding=this.cfg.dot.size+this.cfg.dot.strokeWidth+"px";this.line.curve(this.cfg.line.mode==="curve"?_.curveCatmullRom:_.curveLinear);this.area.curve(this.cfg.line.mode==="curve"?_.curveCatmullRom:_.curveLinear);this.tip.toggle(((e=this.cfg).tip||(e.tip={})).enabled!=null?this.cfg.tip.enabled:true);e=[0,0],i=e[0],r=e[1];for(n=0,a=this.parsed.length;n<a;++n){s=n;for(o=0,u=this.parsed[s].pts.length;o<u;++o){l=o;d=this.parsed[s].pts[l];if(!isNaN(d.y0)&&i>d.y0){i=d.y0}if(!isNaN(d.y1)&&i>d.y1){i=d.y1}if(!isNaN(d.y0)&&r<d.y0){r=d.y0}if(!isNaN(d.y1)&&r<d.y1){r=d.y1}}}this.extent={x:_.extent(this.data,function(t){return t._order}),y:[this.cfg.mode==="bump"?i>1?i:1:i,this.cfg.mode==="bump"?this.parsed.length||1:r===i?i+1:r]};this.scale.x.domain(this.extent.x);this.scale.y.domain(this.cfg.mode==="bump"?[this.extent.y[1],this.extent.y[0]]:this.extent.y);c=(e=Math.ceil(this.layout.getBox("yaxis").height/40))>2?e:2;f=this.cfg.mode==="bump"?function(){var t,e,i,r=[];for(t=1,e=(i=this.parsed.length||1)>1?i:1;t<=e;++t){r.push(t)}return r}.call(this):this.scale.y.ticks((e=((h=this.cfg).yaxis||(h.yaxis={})).tick.count||4)<c?e:c);p=A.utils.format.auto(f);this.legend.config(import$(import$({},this.cfg.legend),this.cfg.mode==="diff"?{selectable:false}:{}));this.legend.update();this.yaxis.config(this.cfg.yaxis);this.yaxis.ticks(f);this.yaxis.scale(this.scale.y);if(this.cfg.mode==="bump"){this.yaxis.caption(M("rank"))}else{if(this.parsed.length>1){y=Array.from(new Set(this.parsed.map(function(t){return t.bind.unit}))).filter(function(t){return t});if(y.length>1){this.yaxis.caption("")}else{this.yaxis.caption(y[0]||"")}}else{g=(this.parsed[0]||{}).bind||{};this.yaxis.caption((g.name||g.key||"")+(g.unit?"("+g.unit+")":""))}}this.xaxis.config(this.cfg.xaxis);this.xaxis.ticks(this.data.map(function(t){return{v:t._order,t:t.orderText}}));this.xaxis.scale(this.scale.x);this.xaxis.caption((m=this.binding.order)?(m.name||m.key||"")+(this.binding.order.unit?"("+this.binding.order.unit+")":""):"");for(n=0;n<2;++n){s=n;this.layout.update(false);x=this.layout.getBox("view");e=[x.width,x.height],v=e[0],b=e[1];this.tint.set(this.cfg.palette);k=this.cfg.dot.size+this.cfg.dot.strokeWidth;N=!this.cfg.stack&&this.cfg.mode==="area"?this.cfg.area.offset:0;this.scale.x.range([0,v-k]);this.scale.y.range([b,b*N]);this.xaxis.render();w.push(this.yaxis.render())}return w},render:function(){var r,n,a,s,o,t,e,u,i,l,d,c,f,h,p,y,g,m,x=this;r=this.scale,n=this.tint,a=this.extent,s=this.cfg;o=this.cfg.dot.size;t=this.layout.getBox("view");e=this.layout.getBox("yaxis");u=(i=this.parsed.length)>1?i:1;l=!this.cfg.stack&&this.cfg.mode==="area"?(this.box.height-this.cfg.dot.size)*this.cfg.area.offset:0;d=this.g.diff.selectAll("line.data").data(this.bars);d.exit().remove();d.enter().append("line").attr("class","data").attr("x1",function(t,e){return r.x(t.x)}).attr("x2",function(t,e){return r.x(t.x)}).attr("y1",function(t,e){return r.y(t.yh)+Math.abs(r.y(t.yh)-r.y(t.yl))/2}).attr("y2",function(t,e){return r.y(t.yh)+Math.abs(r.y(t.yh)-r.y(t.yl))/2}).attr("stroke-linecap",s.line.cap).attr("opacity",0);this.g.diff.selectAll("line.data").transition().duration(150).attr("x1",function(t,e){return r.x(t.x)}).attr("x2",function(t,e){return r.x(t.x)}).attr("y1",function(t,e){return r.y(t.yh)}).attr("y2",function(t,e){return r.y(t.yh)+Math.abs(r.y(t.yh)-r.y(t.yl))}).attr("stroke",function(t,e){if(t.y1>t.y0>0){return s.diff.positive}else{return s.diff.negative}}).attr("stroke-width",s.line.strokeWidth).attr("opacity",1);f=[];for(h=this.parsed.length-1;h>=0;--h){p=h;f.push(this.parsed[p])}c=f;y=this.g.line.selectAll("path.data").data(this.cfg.mode==="diff"?[]:c,function(t){return t.bind.key});y.exit().remove();y.enter().append("path").attr("class","data").attr("fill","none").attr("d",function(t,e){var i;if((i=x.cfg.mode)==="streamgraph"||i==="area"){return x.area(t.pts)}else{return x.line(t.pts)}}).attr("stroke",function(t,e){return x.tint.get(t.color)}).attr("stroke-width",s.line.strokeWidth);this.g.line.selectAll("path.data").transition().duration(150).attr("transform",function(t,e){return"translate(0,-"+(u-e-1)*l/u+")"}).style("opacity",function(t,e){if(x.legend.isSelected(t.bind.key)){return 1}else{return.3}}).attr("d",function(t,e){var i;if((i=x.cfg.mode)==="streamgraph"||i==="area"){return x.area(t.pts)}else{return x.line(t.pts)}}).attr("stroke",function(t,e){return x.tint.get(t.color)}).attr("stroke-width",s.line.strokeWidth).attr("fill",function(t,e){var i;if((i=x.cfg.mode)==="streamgraph"||i==="area"){return x.tint.get(t.color)}else{return"none"}}).attr("fill-opacity",s.area.opacity);g=!this.cfg.dot.show?[]:this.parsed;m=this.g.dot.selectAll("g.dot").data(g,function(t){return t.bind.key});m.exit().remove();m.enter().append("g").attr("class","dot");this.g.dot.selectAll("g.dot").style("opacity",function(t,e){if(x.legend.isSelected(t.bind.key)){return 1}else{return.3}}).each(function(t,i){var e;e=_.select(this).selectAll("circle.dot").data(t.pts);e.exit().remove();e.enter().append("circle").attr("class","dot").attr("r",o).attr("fill",s.dot.fill?n.get(t.color):s.background).attr("stroke",n.get(t.bind.name||t.bind.key)).attr("stroke-width",s.dot.strokeWidth);_.select(this).selectAll("circle.dot").filter(function(t,e){return isNaN(t.y1)}).attr("cx",function(t,e){if(isNaN(r.x(t.x))){return r.x(a.x[0])}else{return r.x(t.x)}}).attr("cy",function(t,e){return r.y(a.y[0])}).transition(150).attr("opacity",0);return _.select(this).selectAll("circle.dot").filter(function(t,e){return!isNaN(t.y1)}).attr("cx",function(t,e){return r.x(t.x)}).attr("cy",function(t,e){return r.y(t.y1)-i*l/u}).attr("r",o).attr("fill",s.dot.fill?n.get(t.color):s.background).attr("stroke",n.get(t.color)).attr("stroke-width",s.dot.strokeWidth).transition(150).attr("opacity",1)});this.legend.render();this.xaxis.render();return this.yaxis.render()}}};function import$(t,e){var i={}.hasOwnProperty;for(var r in e)if(i.call(e,r))t[r]=e[r];return t}</script></div>