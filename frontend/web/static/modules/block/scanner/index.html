<div class="ldcv"><div class="base"><div class="inner position-relative"><script type="@plotdb/block">module.exports={interface:function(){var t=this;return{get:function(){t.itf.start();return t.ldcv.get()},set:function(e){t.itf.stop();return t.ldcv.set(e)}}},init:function(e){var t,n,r,i,o=this;t=e.root;n=new BarcodeDetector;this.ldcv=new ldcover({root:t});this.cache={};this.info={};r=new ldview({root:t,text:{isbn:function(e){var t,n;t=e.node;n=(o.info||{}).isbn||"";return!n?n:"ISBN: "+n},title:function(e){var t;t=e.node;return(o.info||{}).title||o.value||""}},action:{click:{get:function(e){var t;t=e.node;o.itf.stop();return o.ldcv.set(o.value)}}},handler:{info:function(e){var t;t=e.node;return t.classList.toggle("d-none",!o.value)}}});i=r.get("video");this.time={_fps_delay:200};return this.itf={stop:function(){return Promise.resolve().then(function(){var e,t,n,r,i=[];o.running=false;if(!o.mediastream){return}if(!(e=o.mediastream.getTracks())){return}for(t=0,n=e.length;t<n;++t){r=t;i.push(e[r].stop())}return i})},start:function(){return o.itf.stop().then(function(){o.running=true;return o.itf.prepare().then(function(){return requestAnimationFrame(function(e){return o.itf.handler(e,true)})})})},handler:function(e,t){var n,r;t==null&&(t=false);if(!o.running){return}o.time.now=e;n=o.time.isThrottled?(r=o.time._fps_delay)>1e3?r:1e3:o.time._fps_delay;if(t||o.time.now-o.time.last>=n){o.time.last=e;o.itf.render()}return requestAnimationFrame(function(e){return o.itf.handler(e,false)})},render:function(){if(!o.running){return}return n.detect(i).then(function(e){e.forEach(function(e){return o.value=e.rawValue});if(o.value&&/^\d+$/.exec(o.value+"")){Promise.resolve().then(function(){if(o.cache[o.value]){return o.cache[o.value]}return function(r){return o.cache[r]=Promise.resolve().then(function(){return ld$.fetch("/api/code/"+r,{method:"GET"},{type:"json"}).then(function(e){var t,n;e==null&&(e={});o.cache[r]=t=!(n=(e.items||(e.items=[]))[0])?{}:{title:n.volumeInfo.title,isbn:r};if(r!==o.value){return lderror.reject(999)}return t})})}(o.value)}).then(function(e){o.info=e;return r.render(["isbn","info","title"])})["catch"](function(e){if(lderror.id(e)===999){}else{return Promise.reject(e)}})}return r.render(["isbn","info","title"])})},prepare:function(){var e=this;return navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(function(n){e.mediastream=n;return new Promise(function(e,t){i.addEventListener("loadedmetadata",function(){if(i.readyState===4){return e()}});i.srcObject=n;return i.autoplay=true})})},prepareMobile:function(){var e=this;return navigator.mediaDevices.getUserMedia({video:true}).then(function(a){return navigator.mediaDevices.enumerateDevices().then(function(e){var t,n,r,i,o;t={};if(e.length>0){t.front=t.back=e[0].deviceId}Array.from(e).forEach(function(e){if(e.kind!=="videoinput"||!e.label){return}if(/後置|back/.exec(e.label.toLowerCase())){t.back=e.deviceId}if(/前置|front/.exec(e.label.toLowerCase())){return t.front=e.deviceId}});if(n=a.getTracks()){for(r=0,i=n.length;r<i;++r){o=r;n[o].stop()}}return navigator.mediaDevices.getUserMedia({video:true,deviceId:{exact:t.back}})})}).then(function(n){e.mediastream=n;return new Promise(function(e,t){i.addEventListener("loadedmetadata",function(){if(i.readyState===4){return e()}});i.srcObject=n;return i.autoplay=true})})}}}};</script><style type="text/css">.base{width:800px;max-width:90%;height:600px;max-height:90%}[ld=info]{position:absolute;bottom:1em;right:1em;background:#fff;border-radius:.25em;background:#fff;padding:.5em}[ld=close]{position:absolute;top:.25em;right:.5em;cursor:pointer}video{width:100%;height:100%}</style><video ld="video" autoplay playsinline></video><div class="text-lg" ld="close" data-ldcv-set=""><i class="i-close"></i></div><div class="d-none" ld="info"><div class="text-sm" ld="isbn"></div><div class="btn-group"><div class="btn btn-lg btn-outline-secondary" ld="title"></div><div class="btn btn-lg btn-primary" ld="get">確定</div></div></div></div></div></div>